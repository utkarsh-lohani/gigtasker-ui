<div class="task-page">
    <!-- Floating Background Blobs -->
    <div class="blob blob1"></div>
    <div class="blob blob2"></div>
    <div class="blob blob3"></div>

    <div
        class="task-card-glass"
        (mousemove)="handleTilt($event)"
        (mouseleave)="resetTilt()"
        [style.--tiltX]="tiltX()"
        [style.--tiltY]="tiltY()"
    >
        @if (isLoading()) {
        <div class="loading-state">Loading...</div>
        } @else if (task()) {

        <!-- Header -->
        <div class="header">
            <h1>{{ task()?.title }}</h1>
            <mat-chip-set>
                <mat-chip [class]="task()?.status">{{ task()?.status }}</mat-chip>
            </mat-chip-set>
            <p class="posted-by">Posted by User #{{ task()?.posterUserId }}</p>
        </div>

        <!-- Metrics -->
        <div class="metrics">
            <div class="metric">
                <mat-icon>attach_money</mat-icon>
                <span>
                    {{ task()?.minPay | currency }} -
                    {{ task()?.maxPay ? (task()?.maxPay | currency) : 'No Limit' }}
                </span>
            </div>

            <div class="metric">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ task()?.deadline | date : 'mediumDate' }}</span>
            </div>
        </div>

        <mat-divider></mat-divider>

        <!-- Description -->
        <p class="description">{{ task()?.description }}</p>

        <!-- Actions -->
        <div class="actions">
            @if (isAssignedWorker() && task()?.status === 'ASSIGNED') {
            <button mat-flat-button class="primary-btn" (click)="completeTask()">
                <mat-icon>check_circle</mat-icon> Mark Done
            </button>
            } @if (!isPoster() && task()?.status === 'OPEN') {
            <button mat-flat-button class="primary-btn" (click)="openBidDialog()">Place Bid</button>
            } @if (isPoster() && (task()?.status === 'OPEN' || task()?.status === 'ASSIGNED')) {
            <button mat-stroked-button color="warn" class="glass-btn" (click)="cancelTask()">
                Cancel
            </button>
            } @if ((isPoster() || isAssignedWorker()) && task()?.status === 'COMPLETED') {
            <button mat-stroked-button class="glass-btn" (click)="openReviewDialog()">
                <mat-icon>star_rate</mat-icon> Leave Review
            </button>
            }

            <button mat-stroked-button class="glass-btn" (click)="contactUser()">
                <mat-icon>chat</mat-icon> Contact
            </button>
        </div>

        <!-- Bids -->
        @if (isPoster() && task()?.status === 'OPEN') {
        <div class="bids-section">
            <h2>Current Bids ({{ bids().length }})</h2>

            <div class="bid-list">
                @for (bid of bids(); track bid.bidId) {
                <div class="bid-item">
                    <div class="bid-left">
                        <h3>{{ bid.bidderName }}</h3>
                        <p>{{ bid.proposal }}</p>
                    </div>

                    <div class="bid-right">
                        <span class="amount">{{ bid.amount | currency }}</span>
                        <button mat-flat-button class="primary-btn small" (click)="acceptBid(bid)">
                            Accept
                        </button>
                    </div>
                </div>
                } @if (bids().length === 0) {
                <p class="empty">No bids yetâ€¦</p>
                }
            </div>
        </div>
        } }
    </div>
</div>
